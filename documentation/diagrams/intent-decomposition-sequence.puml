@startuml intent-decomposition-sequence

title Stage 1: Intent Decomposition - Sequence Diagram

actor User
participant "Frontend" as FE
participant "API Gateway" as API
participant "Auth Middleware" as Auth
participant "Intent Controller" as Controller
participant "Intent Service" as Service
participant "OpenAI API" as OpenAI
database "Database" as DB

User -> FE: Submit research abstract
activate FE

FE -> API: POST /v1/stages/intent\n{abstract: "..."}
activate API

API -> Auth: Verify JWT token
activate Auth
Auth -> Auth: Extract user ID
Auth --> API: User authenticated
deactivate Auth

API -> Controller: handleIntentDecomposition(req)
activate Controller

Controller -> Controller: Validate input
note right
  - Check abstract not empty
  - Check length â‰¤ 5000 chars
end note

alt Invalid input
  Controller --> API: 400 Bad Request
  API --> FE: Error response
  FE --> User: Show validation error
else Valid input
  
  Controller -> Service: decomposeIntent(abstract, userId)
  activate Service
  
  Service -> Service: Prepare structured prompt
  note right
    Prompt engineering:
    "Extract the following from this abstract:
    1. Problem statement
    2. Proposed solution
    3. Methodology
    4. Expected contributions"
  end note
  
  Service -> OpenAI: POST /v1/chat/completions
  activate OpenAI
  
  alt API Success
    OpenAI --> Service: LLM response (JSON)
    deactivate OpenAI
    
    Service -> Service: Parse response
    Service -> Service: Structure output
    note right
      {
        problemStatement: "...",
        proposedSolution: "...",
        methodology: "...",
        expectedContributions: "..."
      }
    end note
    
    Service --> Controller: Structured intent
    deactivate Service
    
    Controller --> API: 200 OK + structured data
    API --> FE: Success response
    FE --> User: Display decomposed intent
    
  else Rate Limit Exceeded
    OpenAI --> Service: 429 Rate Limit
    deactivate OpenAI
    Service --> Controller: Rate limit error
    deactivate Service
    Controller --> API: 429 Too Many Requests
    API --> FE: Error response
    FE --> User: "Too many requests, try again"
    
  else API Error
    OpenAI --> Service: 500 Error
    deactivate OpenAI
    Service -> Service: Log error
    Service --> Controller: API error
    deactivate Service
    Controller --> API: 500 Internal Server Error
    API --> FE: Error response
    FE --> User: "Service unavailable"
  end
  
end

deactivate Controller
deactivate API
deactivate FE

@enduml
