@startuml password-reset-sequence

title Password Reset Flow

actor User
participant "API Gateway" as API
participant "Auth Controller" as Controller
participant "Auth Service" as Service
participant "Prisma ORM" as Prisma
database "PostgreSQL" as DB
participant "BullMQ" as Queue
participant "Email Worker" as Worker
participant "Email Service" as Email

== Step 1: Request Password Reset ==

User -> API: POST /v1/auth/forgot-password\n{email}
activate API

API -> Controller: forgotPassword(req, res)
activate Controller

Controller -> Service: requestPasswordReset(email)
activate Service

' Find user by email
Service -> Prisma: findUnique(users, {where: {email}})
activate Prisma
Prisma -> DB: SELECT * FROM users WHERE email = ?
activate DB
DB --> Prisma: User record
deactivate DB
Prisma --> Service: User
deactivate Prisma

alt User not found
    Service -> Service: Log attempt (security)
    note right: Don't reveal if email exists\n(security best practice)
    Service --> Controller: 200 OK (fake success)
    Controller --> API: {success: true,\nmessage: "If email exists, reset link sent"}
    API --> User: 200 OK
else User found
    ' Generate reset token
    Service -> Service: Generate UUID v4 token
    
    ' Save reset token
    Service -> Prisma: create(password_reset_tokens,\n{userId, token, expiresAt: NOW() + 1 hour})
    activate Prisma
    Prisma -> DB: INSERT INTO password_reset_tokens\n(user_id, token, expires_at)
    activate DB
    note right: Token expires in 1 hour
    DB --> Prisma: Token created
    deactivate DB
    Prisma --> Service: {token}
    deactivate Prisma
    
    ' Queue password reset email
    Service -> Queue: Add email job\n{type: SEND_EMAIL,\nsubtype: PASSWORD_RESET,\nuserId, token}
    activate Queue
    Queue --> Service: Job ID
    deactivate Queue
    
    Service --> Controller: {success: true}
    deactivate Service
    
    Controller --> API: 200 OK\n{success: true,\nmessage: "If email exists, reset link sent"}
    deactivate Controller
    
    API --> User: 200 OK
    deactivate API
    
    ' Async email sending
    Queue -> Worker: Process email job
    activate Worker
    Worker -> Email: sendPasswordResetEmail(email, token)
    activate Email
    Email -> Email: Generate reset link\n{baseUrl}/reset-password?token={token}
    Email -> Email: Send email via SMTP
    Email --> Worker: Email sent
    deactivate Email
    Worker --> Queue: Job completed
    deactivate Worker
end

note over User
  User receives email with reset link
  Link expires in 1 hour
end note

== Step 2: Reset Password ==

User -> API: POST /v1/auth/reset-password\n{token, newPassword}
activate API

API -> Controller: resetPassword(req, res)
activate Controller

Controller -> Service: resetPassword(token, newPassword)
activate Service

' Find reset token
Service -> Prisma: findFirst(password_reset_tokens,\n{where: {token, usedAt: null},\ninclude: {user: true}})
activate Prisma
Prisma -> DB: SELECT * FROM password_reset_tokens\nWHERE token = ? AND used_at IS NULL
activate DB
DB --> Prisma: Token record with user
deactivate DB
Prisma --> Service: {token, user}
deactivate Prisma

alt Token not found or already used
    Service --> Controller: 400 Bad Request
    Controller --> API: {success: false,\nerror: "Invalid or expired token"}
    API --> User: 400 Bad Request
else Token found
    ' Check if token expired
    Service -> Service: Check expiresAt > NOW()
    
    alt Token expired
        Service --> Controller: 400 Bad Request
        Controller --> API: {success: false,\nerror: "Token expired"}
        API --> User: 400 Bad Request
    else Token valid
        ' Validate new password
        Service -> Service: Validate password strength
        
        alt Password too weak
            Service --> Controller: 400 Bad Request
            Controller --> API: {success: false,\nerror: "Password too weak"}
            API --> User: 400 Bad Request
        else Password valid
            ' Hash new password
            Service -> Service: bcrypt.hash(newPassword, 12)
            
            ' Update password and mark token as used
            Service -> Prisma: $transaction([...])
            activate Prisma
            note right: Atomic transaction:\n1. Update password\n2. Mark token as used\n3. Revoke all refresh tokens
            
            Prisma -> DB: BEGIN TRANSACTION
            activate DB
            
            ' Update user password
            Prisma -> DB: UPDATE users\nSET password_hash = ?\nWHERE id = ?
            DB --> Prisma: Password updated
            
            ' Mark token as used
            Prisma -> DB: UPDATE password_reset_tokens\nSET used_at = NOW()\nWHERE id = ?
            DB --> Prisma: Token marked as used
            
            ' Revoke all refresh tokens (force re-login)
            Prisma -> DB: UPDATE refresh_tokens\nSET revoked_at = NOW()\nWHERE user_id = ?\nAND revoked_at IS NULL
            note right: Security: Force logout\nfrom all devices
            DB --> Prisma: Refresh tokens revoked
            
            Prisma -> DB: COMMIT TRANSACTION
            deactivate DB
            Prisma --> Service: Transaction successful
            deactivate Prisma
            
            Service --> Controller: {success: true}
            deactivate Service
            
            Controller --> API: 200 OK\n{success: true,\nmessage: "Password reset successful"}
            deactivate Controller
            
            API --> User: 200 OK
            deactivate API
            
            note over User
              Password reset successful!
              
              All devices logged out (security)
              User must login again with new password
            end note
        end
    end
end

@enduml
