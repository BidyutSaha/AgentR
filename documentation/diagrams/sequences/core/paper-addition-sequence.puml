@startuml paper-addition-sequence

title Paper Addition with Scoring Job Flow

actor User
participant "API Gateway" as API
participant "Paper Controller" as Controller
participant "Paper Service" as Service
participant "Prisma ORM" as Prisma
database "PostgreSQL" as DB
participant "BullMQ" as Queue
participant "Redis" as Redis

User -> API: POST /v1/candidate-papers\nAuthorization: Bearer {accessToken}\n{projectId, title, abstract, link}
activate API

API -> API: Verify JWT token
note right: Extract userId from token

API -> Controller: addPaper(req, res)
activate Controller

Controller -> Service: addPaperToProject(userId, paperData)
activate Service

' Verify project exists and belongs to user
Service -> Prisma: findUnique(user_projects,\n{where: {id: projectId}})
activate Prisma
Prisma -> DB: SELECT * FROM user_projects\nWHERE id = ?
activate DB
DB --> Prisma: Project record
deactivate DB
Prisma --> Service: Project
deactivate Prisma

alt Project not found
    Service --> Controller: 404 Not Found
    Controller --> API: {success: false, error: "Project not found"}
    API --> User: 404 Not Found
else Project found
    ' Check project belongs to user
    alt Project belongs to different user
        Service --> Controller: 403 Forbidden
        Controller --> API: {success: false, error: "Unauthorized"}
        API --> User: 403 Forbidden
    else Project belongs to user
        ' Check project has Stage 1+2 results
        Service -> Service: Check intentProcessedStatus = EVALUATED\nAND searchQueryProcessedStatus = EVALUATED
        
        alt Project not fully processed
            Service --> Controller: 400 Bad Request
            Controller --> API: {success: false,\nerror: "Project must complete Stage 1+2 first"}
            API --> User: 400 Bad Request
        else Project ready
            ' Create paper record
            Service -> Prisma: create(candidate_papers,\n{projectId, title, abstract, link,\nisProcessedByLlm: false})
            activate Prisma
            Prisma -> DB: INSERT INTO candidate_papers\n(project_id, title, abstract, link,\nis_processed_by_llm)
            activate DB
            DB --> Prisma: Paper created
            deactivate DB
            Prisma --> Service: {id: paperId, ...}
            deactivate Prisma
            
            ' Create background job record
            Service -> Prisma: create(background_jobs,\n{userId, projectId, paperId,\njobType: PAPER_SCORING,\nstatus: PENDING})
            activate Prisma
            Prisma -> DB: INSERT INTO background_jobs\n(user_id, project_id, paper_id,\njob_type, status)
            activate DB
            DB --> Prisma: Job created
            deactivate DB
            Prisma --> Service: {id: jobId, ...}
            deactivate Prisma
            
            ' Create BullMQ job
            Service -> Queue: Add job to paper queue\n{name: PAPER_SCORING,\ndata: {userId, projectId, paperId,\ntitle, abstract}}
            activate Queue
            Queue -> Redis: Store job payload
            activate Redis
            Redis --> Queue: Job stored
            deactivate Redis
            Queue --> Service: {bullmqJobId}
            deactivate Queue
            
            ' Update background_jobs with BullMQ job ID
            Service -> Prisma: update(background_jobs,\n{where: {id: jobId},\ndata: {bullmqJobId}})
            activate Prisma
            Prisma -> DB: UPDATE background_jobs\nSET bullmq_job_id = ?\nWHERE id = ?
            activate DB
            DB --> Prisma: Updated
            deactivate DB
            Prisma --> Service: Success
            deactivate Prisma
            
            Service --> Controller: {success: true,\npaper, jobId}
            deactivate Service
            
            Controller --> API: 202 Accepted\n{success: true,\ndata: {paper, jobId},\nmessage: "Paper added.\nScoring started."}
            deactivate Controller
            
            API --> User: 202 Accepted\n{paper, jobId}
            deactivate API
            
            note over User
              User receives:
              - Paper ID
              - Job ID
              
              Can monitor job status:
              GET /v1/jobs?paperId={paperId}
              
              Paper will be scored asynchronously
            end note
        end
    end
end

note over Queue, Redis
  BullMQ worker will pick up job
  and process Stage 3 (Paper Scoring)
  
  See: paper-scoring-sequence.puml
end note

@enduml
