@startuml password-reset-activity

title Password Reset Activity Diagram

|User|
start

:Submit forgot password\n(email);

|System|
:Find user by email;

if (User exists?) then (yes)
  :Generate UUID reset token;
  
  :Save token to database\n(expires in 1 hour);
  
  :Queue password reset email;
  
  :Return 200 OK\n"If email exists, link sent";
  
  fork
    |User|
    :Receive email;
    
    :Click reset link;
    
    :Submit new password\n(token, newPassword);
    
  fork again
    |Email Worker|
    :Pick up email job;
    
    :Generate reset link;
    
    :Send email via SMTP;
    
    :Mark job completed;
  end fork
  
  |System|
  :Find reset token;
  
  if (Token found\nand not used?) then (yes)
    :Check token expiry;
    
    if (Not expired?) then (yes)
      :Validate new password\nstrength;
      
      if (Password strong?) then (yes)
        :Hash new password\n(bcrypt, cost 12);
        
        partition "Atomic Transaction" {
          :Update user password;
          
          :Mark token as used\n(used_at = NOW());
          
          :Revoke all refresh tokens\n(force logout all devices);
          
          :Commit transaction;
        }
        
        :Return 200 OK\n"Password reset successful";
        
        |User|
        :Login with new password;
        
        stop
        
      else (no - weak)
        :Return 400 Bad Request\n"Password too weak";
        stop
      endif
      
    else (yes - expired)
      :Return 400 Bad Request\n"Token expired";
      stop
    endif
    
  else (no - invalid/used)
    :Return 400 Bad Request\n"Invalid or expired token";
    stop
  endif
  
else (no - not found)
  :Log attempt (security);
  
  :Return 200 OK\n"If email exists, link sent";
  
  note right
    Don't reveal if email exists
    (security best practice)
  end note
  
  stop
endif

@enduml
