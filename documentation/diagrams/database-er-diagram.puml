@startuml database-er-diagram

' ============================================================================
' Literature Review System - Database ER Diagram
' ============================================================================
' This diagram shows all database tables and their relationships
' Last Updated: 2025-12-31
' ============================================================================

' Entity definitions

entity "users" as users {
  * id : UUID <<PK>>
  --
  * email : VARCHAR(255) <<unique>>
  * password_hash : VARCHAR(255)
  first_name : VARCHAR(100)
  last_name : VARCHAR(100)
  * is_verified : BOOLEAN
  * is_active : BOOLEAN
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  last_login : TIMESTAMP
}

entity "email_verification_tokens" as email_tokens {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  * token : VARCHAR(255) <<unique>>
  * expires_at : TIMESTAMP
  * created_at : TIMESTAMP
  used_at : TIMESTAMP
}

entity "password_reset_tokens" as password_tokens {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  * token : VARCHAR(255) <<unique>>
  * expires_at : TIMESTAMP
  * created_at : TIMESTAMP
  used_at : TIMESTAMP
}

entity "refresh_tokens" as refresh_tokens {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  * token : VARCHAR(255) <<unique>>
  * expires_at : TIMESTAMP
  * created_at : TIMESTAMP
  revoked_at : TIMESTAMP
  replaced_by_token : VARCHAR(255)
}

entity "user_projects" as projects {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  * project_name : VARCHAR(255)
  * user_idea : TEXT
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "candidate_papers" as papers {
  * id : UUID <<PK>>
  --
  * project_id : UUID <<FK>>
  * paper_title : VARCHAR(500)
  * paper_abstract : TEXT
  paper_download_link : VARCHAR(500)
  * is_processed_by_llm : BOOLEAN
  semantic_similarity : DECIMAL(5,4)
  similarity_model_name : VARCHAR(100)
  problem_overlap : VARCHAR(20)
  domain_overlap : VARCHAR(20)
  constraint_overlap : VARCHAR(20)
  c1_score : DECIMAL(5,2)
  c1_justification : TEXT
  c1_strengths : TEXT
  c1_weaknesses : TEXT
  c2_score : DECIMAL(5,2)
  c2_justification : TEXT
  c2_contribution_type : TEXT
  c2_relevance_areas : TEXT
  research_gaps : TEXT
  user_novelty : TEXT
  model_used : VARCHAR(100)
  input_tokens_used : INTEGER
  output_tokens_used : INTEGER
  processed_at : TIMESTAMP
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
}

entity "llm_usage_logs" as llm_logs {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  project_id : UUID <<FK>>
  paper_id : UUID <<FK>>
  * stage : VARCHAR(50)
  * model_name : VARCHAR(100)
  * provider : VARCHAR(50)
  * input_tokens : INTEGER
  * output_tokens : INTEGER
  * total_tokens : INTEGER
  input_cost_cents : INTEGER
  output_cost_cents : INTEGER
  total_cost_cents : INTEGER
  duration_ms : INTEGER
  request_id : VARCHAR(255)
  * status : VARCHAR(20)
  error_message : TEXT
  metadata : TEXT
  * created_at : TIMESTAMP
}

' Relationships

users ||--o{ email_tokens : "has"
users ||--o{ password_tokens : "has"
users ||--o{ refresh_tokens : "has"
users ||--o{ projects : "owns"
users ||--o{ llm_logs : "generates"
projects ||--o{ papers : "contains"
projects ||--o{ llm_logs : "tracks"
papers ||--o{ llm_logs : "tracks"

' Notes

note right of users
  Core user authentication table
  - Stores user credentials
  - Email verification status
  - Account active status
end note

note right of email_tokens
  Email verification workflow
  - One-time use tokens
  - Expires after 24 hours
  - Cascade delete with user
end note

note right of password_tokens
  Password reset workflow
  - One-time use tokens
  - Expires after 1 hour
  - Cascade delete with user
end note

note right of refresh_tokens
  JWT refresh token management
  - Expires after 7 days
  - Can be revoked
  - Tracks token rotation
end note

note right of projects
  User research projects
  - Stores project metadata
  - Links to user
  - Cascade delete with user
end note

note right of papers
  Candidate papers for analysis
  - Basic info (title, abstract, link)
  - LLM processing status
  - Semantic similarity scores
  - C1/C2 analysis results
  - Research gap identification
  - Cascade delete with project
end note

note right of llm_logs
  LLM API usage tracking
  - Tracks every OpenAI API call
  - Records tokens and costs
  - Performance metrics (duration)
  - Used for billing and analytics
  - Cascade delete with user
  - SET NULL on project/paper delete
end note

@enduml

